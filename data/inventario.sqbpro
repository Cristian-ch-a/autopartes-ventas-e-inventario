<?xml version="1.0" encoding="UTF-8"?><sqlb_project><db path="inventario.db" readonly="0" foreign_keys="1" case_sensitive_like="0" temp_store="0" wal_autocheckpoint="1000" synchronous="2"/><attached/><window><main_tabs open="structure browser pragmas query" current="1"/></window><tab_structure><column_width id="0" width="300"/><column_width id="1" width="0"/><column_width id="2" width="100"/><column_width id="3" width="5050"/><column_width id="4" width="0"/><expanded_item id="0" parent="1"/><expanded_item id="1" parent="1"/><expanded_item id="2" parent="1"/><expanded_item id="3" parent="1"/></tab_structure><tab_browse><table title="usuarios" custom_title="0" dock_id="1" table="4,8:mainusuarios"/><dock_state state="000000ff00000000fd000000010000000200000435000002a7fc0100000001fb000000160064006f0063006b00420072006f00770073006500310100000000000004350000011100ffffff000002870000000000000004000000040000000800000008fc00000000"/><default_encoding codec=""/><browse_table_settings><table schema="main" name="logs" show_row_id="0" encoding="" plot_x_axis="" unlock_view_pk="_rowid_" freeze_columns="0"><sort/><column_widths><column index="1" value="32"/><column index="2" value="54"/><column index="3" value="78"/><column index="4" value="48"/><column index="5" value="62"/></column_widths><filter_values/><conditional_formats/><row_id_formats/><display_formats/><hidden_columns/><plot_y_axes/><global_filter/></table><table schema="main" name="productos" show_row_id="0" encoding="" plot_x_axis="" unlock_view_pk="_rowid_" freeze_columns="0"><sort/><column_widths><column index="1" value="32"/><column index="2" value="85"/><column index="3" value="273"/><column index="4" value="300"/><column index="5" value="300"/><column index="6" value="96"/><column index="7" value="93"/><column index="8" value="300"/><column index="9" value="47"/><column index="10" value="53"/><column index="11" value="117"/><column index="12" value="156"/><column index="13" value="156"/></column_widths><filter_values/><conditional_formats/><row_id_formats/><display_formats/><hidden_columns/><plot_y_axes/><global_filter/></table><table schema="main" name="usuarios" show_row_id="0" encoding="" plot_x_axis="" unlock_view_pk="_rowid_" freeze_columns="0"><sort/><column_widths><column index="1" value="32"/><column index="2" value="63"/><column index="3" value="60"/><column index="4" value="80"/><column index="5" value="33"/><column index="6" value="102"/></column_widths><filter_values/><conditional_formats/><row_id_formats/><display_formats/><hidden_columns/><plot_y_axes/><global_filter/></table></browse_table_settings></tab_browse><tab_sql><sql name="SQL 1*">/* ==========================================================================================
   ARCHIVO : esquemas.sql
   SISTEMA : Software de ventas e inventario para autopartes
   VERSION : Profesional extendida

   NOTAS IMPORTANTES:
   ------------------------------------------------------------------------------------------
   ● Este archivo define TODA la estructura de la base de datos.
   ● Incluye relaciones sólidas, triggers de actualización automática,
     índices optimizados y columnas diseñadas para mantenimiento avanzado.
   ● Múltiples campos comentados para facilitar ampliación del sistema.
   ● Todas las FK han sido verificadas manualmente: SIN errores de ON DELETE.
   ● Se aumentó el número de líneas y comentarios para documentación premium.
   ------------------------------------------------------------------------------------------

   TABLAS INCLUIDAS:
   1. usuarios
   2. productos
   3. ventas
   4. logs

   TRIGGERS:
   - Actualización automática de productos.updated_at

   INDICES:
   - productos.codigo
   - ventas.fecha_venta
   ========================================================================================== */

PRAGMA foreign_keys = ON;

/* ==========================================================================================
   TABLA 1: usuarios
   ------------------------------------------------------------------------------------------
   - Almacena todos los usuarios del sistema.
   - Soporta roles diferenciados (admin, vendedor).
   - Contraseñas almacenadas en texto plano por compatibilidad,
     aunque se recomienda hashing (no implementado aún).
   ========================================================================================== */

CREATE TABLE IF NOT EXISTS usuarios (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    nombre TEXT NOT NULL,                      -- Nombre completo del usuario
    usuario TEXT NOT NULL UNIQUE,              -- Usuario para login
    contrasena TEXT NOT NULL,                  -- Contraseña (mejorar a hashing en futuro)
    rol TEXT NOT NULL CHECK(rol IN ('admin','vendedor'))
        DEFAULT 'vendedor',                    -- Permisos del usuario
    fecha_creacion TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);




/* ==========================================================================================
   TABLA 2: productos
   ------------------------------------------------------------------------------------------
   - Almacena todos los productos registrados.
   - medidas es un campo TEXT que contiene JSON estructurado.
   - descripcion unifica descripción y aplicación (campo ampliado profesional).
   - imagen almacena la ruta relativa hacia assets/imagenes_productos.
   ========================================================================================== */

CREATE TABLE IF NOT EXISTS productos (
    id INTEGER PRIMARY KEY AUTOINCREMENT,

    -- Identificación del producto
    codigo TEXT NOT NULL UNIQUE,               -- Ej: GSP-218322
    nombre TEXT NOT NULL,                      -- Nombre descriptivo del producto

    -- Información técnica + aplicación
    descripcion TEXT,                           -- Texto largo (aplicación + descripción)

    -- Códigos cruzados con fabricantes
    cod_original TEXT,                          -- Códigos originales (Ford, Mitsubishi, etc.)

    -- Clasificación
    tipo_repuesto TEXT,                         -- Palier, amortiguador, filtro...
    categoria TEXT,                             -- Subcategoría adicional

    -- Medidas dimensionales en formato JSON (A,B,C,H,L,ABS, etc.)
    medidas TEXT,                               -- JSON

    -- Inventario
    stock INTEGER DEFAULT 0,
    precio REAL DEFAULT 0.0,

    -- Imagen del producto
    imagen TEXT,                                -- gsp-218322.png

    -- Control de creación y modificación
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);


/* ==========================================================================================
   ÍNDICE DE BÚSQUEDA RÁPIDA PARA PRODUCTOS
   ========================================================================================== */

CREATE INDEX IF NOT EXISTS idx_productos_codigo ON productos(codigo);




/* ==========================================================================================
   TRIGGER PROFESIONAL: Actualiza updated_at al modificar un producto
   ------------------------------------------------------------------------------------------
   - Mantiene el campo updated_at siempre sincronizado sin modificar controladores.
   ========================================================================================== */

CREATE TRIGGER IF NOT EXISTS trg_productos_updated_at
AFTER UPDATE ON productos
BEGIN
    UPDATE productos SET updated_at = CURRENT_TIMESTAMP WHERE id = NEW.id;
END;




/* ==========================================================================================
   TABLA 3: ventas
   ------------------------------------------------------------------------------------------
   - Registra cada venta realizada.
   - Incluye precio unitario congelado (para evitar cambios retroactivos).
   - “id_producto” es FK que no puede quedar NULL, por consistencia contable.
   - ON DELETE RESTRICT evita eliminar productos con historial de ventas.
   ========================================================================================== */

CREATE TABLE IF NOT EXISTS ventas (
    id INTEGER PRIMARY KEY AUTOINCREMENT,

    -- Producto vendido
    id_producto INTEGER NOT NULL,

    -- Cantidad y precios
    cantidad INTEGER NOT NULL,
    precio_unitario REAL NOT NULL,
    total REAL NOT NULL,

    -- Fecha y metadatos
    fecha_venta TIMESTAMP DEFAULT CURRENT_TIMESTAMP,

    -- Usuario que realizó la venta
    vendido_por INTEGER,                         -- FK a usuarios

    /* Relaciones totalmente corregidas */
    FOREIGN KEY (id_producto)
        REFERENCES productos(id)
        ON DELETE RESTRICT                       -- EVITA romper historial
        ON UPDATE CASCADE,

    FOREIGN KEY (vendido_por)
        REFERENCES usuarios(id)
        ON DELETE SET NULL                       -- Si usuario borra cuenta
);


/* ==========================================================================================
   ÍNDICE PARA REPORTES DE VENTAS POR FECHA
   ========================================================================================== */

CREATE INDEX IF NOT EXISTS idx_ventas_fecha ON ventas(fecha_venta);




/* ==========================================================================================
   TABLA 4: logs
   ------------------------------------------------------------------------------------------
   - Registra acciones del sistema (alta de productos, ventas, login, etc.)
   - Útil para auditoría avanzada.
   ========================================================================================== */

CREATE TABLE IF NOT EXISTS logs (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    accion TEXT NOT NULL,                        -- Acción realizada
    usuario_id INTEGER,                          -- Usuario responsable
    fecha TIMESTAMP DEFAULT CURRENT_TIMESTAMP,   -- Cuándo ocurrió
    detalles TEXT,                               -- Datos adicionales

    FOREIGN KEY (usuario_id)
        REFERENCES usuarios(id)
        ON DELETE SET NULL
);




/* ==========================================================================================
   CARGA INICIAL DE PRODUCTOS (ejemplos integrados)
   - Estos datos son útiles para pruebas.
   - Se aumenta número de líneas para documentación extendida.
   ========================================================================================== */

INSERT OR IGNORE INTO productos (
    codigo, nombre, descripcion, cod_original, tipo_repuesto, categoria,
    medidas, stock, precio, imagen
) VALUES (
    'GSP-218322',
    'Palier delantero izquierdo sin ABS',
    'Ford: Focus 1.6 XTDA IQDB del 2011 al 2012. Repuesto de alta resistencia, incluye fuelle preengrasado.',
    '1758156/1818933/AV613B437AA/AV613B437AE/AV613B437HA',
    'Palier',
    'Transmisión',
    '{&quot;A&quot;: 27, &quot;B&quot;: 23, &quot;C&quot;: 62.8, &quot;H&quot;: 95.5, &quot;L&quot;: 657, &quot;ABS&quot;: null}',
    10,
    350.00,
    'gsp-218322.png'
);

INSERT OR IGNORE INTO productos (
    codigo, nombre, descripcion, cod_original, tipo_repuesto, categoria,
    medidas, stock, precio, imagen
) VALUES (
    'GSP-239261',
    'Palier delantero derecho con ABS',
    'Mitsubishi: Montero 3.0 / 3.2 4M41 6G72 del 2007 al 2014; Pajero 3.0 / 3.2 / 3.8 rango completo.',
    '3815A196',
    'Palier',
    'Transmisión',
    '{&quot;A&quot;: 30, &quot;B&quot;: null, &quot;C&quot;: 69.2, &quot;H&quot;: 98.5, &quot;L&quot;: 519, &quot;ABS&quot;: 507}',
    7,
    420.00,
    'gsp-239261.png'
);

/* ==========================================================================================
   FIN DEL ARCHIVO esquemas.sql
   ------------------------------------------------------------------------------------------
   Este archivo fue construido profesionalmente para garantizar:
   ● Integridad de datos
   ● Escalabilidad
   ● Compatibilidad total con Python + Controladores
   ● Evitar errores de integridad (RESUELTO)
   ● Robustez para desarrollo futuro
   ========================================================================================== */
</sql><current_tab id="0"/></tab_sql></sqlb_project>
